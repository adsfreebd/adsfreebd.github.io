<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Downloader</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Ad SDK -->
    <script src='//libtl.com/sdk.js' data-zone='10397973' data-sdk='show_10397973'></script>
    <style>
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.8s ease-out forwards; }
        .slide-up { animation: slideUp 0.6s ease-out forwards; opacity: 0; }
        .animation-delay-200 { animation-delay: 0.2s; }
        .animation-delay-400 { animation-delay: 0.4s; }
        
        /* Slider Styles */
        .slider-container { position: relative; overflow: hidden; }
        .slider-wrapper { display: flex; transition: transform 0.5s ease-in-out; }
        .slider-item { min-width: 100%; box-sizing: border-box; }
        .slider-dots { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 8px; }
        .slider-dot { width: 10px; height: 10px; border-radius: 50%; background-color: rgba(255, 255, 255, 0.5); cursor: pointer; transition: background-color 0.3s; }
        .slider-dot.active { background-color: white; }
        
        body { scrollbar-width: none; }
        body::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-gray-50 font-sans">

    <div id="app" class="container mx-auto p-4 max-w-7xl">
        <!-- Header -->
        <header class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-6 rounded-xl shadow-lg mb-8 fade-in">
            <h1 data-key="main_title" class="text-4xl font-extrabold text-center mb-4">Webapp Sikho</h1>
            <p data-key="main_subtitle" class="text-center text-lg text-blue-100 mb-6">Watch Ads, Unlock, and Download Files for Free!</p>
            <div class="max-w-2xl mx-auto">
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-search text-gray-400"></i>
                    </div>
                    <input type="text" id="searchInput" data-key-placeholder="search_placeholder" placeholder="Search for files..." class="w-full p-3 pl-10 rounded-full bg-white text-gray-800 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-shadow duration-300">
                </div>
            </div>
        </header>

        <!-- Ad Slot 1 -->
        <div id="ad-container-1" class="my-6 flex justify-center min-h-[50px]"></div>

        <!-- Slider -->
        <div id="slider" class="slider-container w-full h-48 md:h-80 bg-gray-300 rounded-xl shadow-lg mb-10 slide-up animation-delay-200">
            <div id="slider-wrapper" class="slider-wrapper h-full"></div>
            <div id="slider-dots" class="slider-dots"></div>
        </div>

        <!-- Ad Slot 2 -->
        <div id="ad-container-2" class="my-6 flex justify-center min-h-[50px]"></div>

        <!-- Files Section -->
        <div class="slide-up animation-delay-400">
            <h2 data-key="available_files" class="text-3xl font-bold text-gray-800 mb-6 border-b-4 border-blue-500 pb-2">Available Files</h2>
            <div id="files-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <!-- Cards injected via JS -->
            </div>
            <div id="no-results" class="hidden text-center py-12">
                <i class="fas fa-file-excel text-5xl text-gray-400 mb-4"></i>
                <p data-key="no_results_text" class="text-xl text-gray-600">No files found matching your search.</p>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-900 text-white py-3 px-5 rounded-lg shadow-2xl opacity-0 transform translate-y-10 transition-all duration-500 z-[60]">
        <p id="toast-message"></p>
    </div>
    
    <!-- Language Modal -->
    <div id="language-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-2xl text-center fade-in">
            <h2 class="text-2xl font-bold mb-6">Choose Your Language</h2>
            <div class="flex flex-col sm:flex-row justify-center gap-4">
                <button class="lang-btn px-6 py-3 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 transition-colors" data-lang="en">English</button>
                <button class="lang-btn px-6 py-3 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600 transition-colors" data-lang="hi">हिन्दी</button>
                <button class="lang-btn px-6 py-3 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600 transition-colors" data-lang="bn">বাংলা</button>
            </div>
        </div>
    </div>

    <!-- CONTENT VIEWER MODAL (Updated for Iframe) -->
    <div id="content-viewer-modal" class="hidden fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-2 sm:p-4">
        <div class="bg-white w-full max-w-5xl h-[85vh] rounded-lg shadow-2xl flex flex-col overflow-hidden relative">
            <!-- Modal Header -->
            <div class="bg-gray-100 p-3 sm:p-4 border-b flex justify-between items-center shrink-0">
                <h3 id="modal-title" class="text-lg font-bold text-gray-800 truncate pr-4">Content Viewer</h3>
                <button id="close-content-modal" class="text-gray-500 hover:text-red-600 transition-colors p-2">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            
            <!-- Modal Body -->
            <div id="modal-body" class="flex-grow bg-gray-50 relative w-full h-full overflow-hidden">
                <!-- Content injected here (Iframe or Text) -->
            </div>

            <!-- Modal Footer (For Text Copy) -->
            <div id="modal-footer" class="bg-gray-100 p-3 border-t hidden shrink-0 text-right">
                <button id="copy-content-btn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm font-semibold shadow-sm">
                    <i class="fas fa-copy mr-2"></i> Copy Text
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-100 py-6 mt-10">
        <div class="container mx-auto px-4">
            <div id="ad-container-3" class="my-4 flex justify-center min-h-[50px]"></div>
            <p class="text-center text-gray-600">&copy; 2025 Webapp Sikho. All rights reserved.</p>
        </div>
    </footer>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyCi7VE87etpG9xuyajJNl-aPDeVqfAQWdQ",
          authDomain: "earning-bot-e0868.firebaseapp.com",
          databaseURL: "https://earning-bot-e0868-default-rtdb.firebaseio.com",
          projectId: "earning-bot-e0868",
          storageBucket: "earning-bot-e0868.firebasestorage.app",
          messagingSenderId: "990309628044",
          appId: "1:990309628044:web:9b29f6f7670ec065c923a9"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // UI Elements
        const sliderWrapper = document.getElementById('slider-wrapper');
        const sliderDotsContainer = document.getElementById('slider-dots');
        const filesGrid = document.getElementById('files-grid');
        const searchInput = document.getElementById('searchInput');
        const noResultsMessage = document.getElementById('no-results');
        const languageModal = document.getElementById('language-modal');
        
        // Modal Elements
        const contentModal = document.getElementById('content-viewer-modal');
        const modalBody = document.getElementById('modal-body');
        const modalTitle = document.getElementById('modal-title');
        const closeModalBtn = document.getElementById('close-content-modal');
        const modalFooter = document.getElementById('modal-footer');
        const copyBtn = document.getElementById('copy-content-btn');

        let sliderInterval;
        let currentSlide = 0;
        let timerDuration = 10;
        let currentLang = 'en';
        let allFilesData = {}; // Store file data

        const translations = {
            en: { main_title: "Webapp Sikho", main_subtitle: "Watch Ads, Unlock, and Download Files for Free!", search_placeholder: "Search for files...", available_files: "Available Files", no_results_text: "No files found matching your search.", no_slides: "No promotional slides available.", slides_error: "Could not load slides.", no_files_uploaded: "No files have been uploaded yet.", files_error: "Could not load files.", unlock_button: "Unlock ({adCount}/{requiredCount})", download_now_button: "Download Now", view_now_button: "View Content", toast_download_starting: "Opening content...", toast_progress: "Progress: {adCount}/{requiredCount}", toast_unlocked: "Unlocked successfully!", toast_ad_error: "Could not load ad.", loading_ad: "Loading ad...", verifying_button: "Wait {countdown}s", },
            hi: { main_title: "वेबऐप सीखो", main_subtitle: "विज्ञापन देखें, अनलॉक करें और मुफ्त में फाइलें डाउनलोड करें!", search_placeholder: "फ़ाइलों के लिए खोजें...", available_files: "उपलब्ध फाइलें", no_results_text: "कोई फ़ाइल नहीं मिली।", no_slides: "कोई स्लाइड उपलब्ध नहीं है।", slides_error: "स्लाइड लोड नहीं हो सकीं।", no_files_uploaded: "कोई फ़ाइल अपलोड नहीं की गई।", files_error: "फ़ाइलें लोड नहीं हो सकीं।", unlock_button: "अनलॉक ({adCount}/{requiredCount})", download_now_button: "अभी डाउनलोड करें", view_now_button: "अभी देखें", toast_download_starting: "कंटेंट खुल रहा है...", toast_progress: "प्रगति: {adCount}/{requiredCount}", toast_unlocked: "अनलॉक हो गया!", toast_ad_error: "विज्ञापन लोड त्रुटि।", loading_ad: "लोड हो रहा है...", verifying_button: "प्रतीक्षा करें {countdown}s", },
            bn: { main_title: "ওয়েবঅ্যাপ শিখুন", main_subtitle: "বিজ্ঞাপন দেখুন, আনলক করুন এবং বিনামূল্যে ফাইল ডাউনলোড করুন!", search_placeholder: "ফাইলের জন্য অনুসন্ধান করুন...", available_files: "উপলব্ধ ফাইল", no_results_text: "কোনো ফাইল পাওয়া যায়নি।", no_slides: "স্লাইড উপলব্ধ নেই।", slides_error: "স্লাইড লোড করা যায়নি।", no_files_uploaded: "এখনো কোনো ফাইল আপলোড করা হয়নি।", files_error: "ফাইল লোড করা যায়নি।", unlock_button: "আনলক করুন ({adCount}/{requiredCount})", download_now_button: "ডাউনলোড করুন", view_now_button: "এখনই দেখুন", toast_download_starting: "কন্টেন্ট খোলা হচ্ছে...", toast_progress: " অগ্রগতি: {adCount}/{requiredCount}", toast_unlocked: "আনলক করা হয়েছে!", toast_ad_error: "বিজ্ঞাপন লোড করা যায়নি।", loading_ad: "লোড হচ্ছে...", verifying_button: "অপেক্ষা করুন {countdown}s", }
        };

        function applyLanguage(lang) {
            currentLang = lang;
            document.documentElement.lang = lang;
            localStorage.setItem('userLanguage', lang);
            document.querySelectorAll('[data-key]').forEach(elem => {
                const key = elem.getAttribute('data-key');
                if (translations[lang][key]) elem.textContent = translations[lang][key];
            });
            document.querySelectorAll('[data-key-placeholder]').forEach(elem => {
                const key = elem.getAttribute('data-key-placeholder');
                if (translations[lang][key]) elem.placeholder = translations[lang][key];
            });
            languageModal.classList.add('hidden');
            loadUserPageData();
        }

        function getText(key, params = {}) {
            let text = translations[currentLang][key] || key;
            for (const param in params) text = text.replace(`{${param}}`, params[param]);
            return text;
        }

        function showToast(key, params = {}) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-message').textContent = getText(key, params);
            toast.classList.remove('opacity-0', 'translate-y-10');
            setTimeout(() => { toast.classList.add('opacity-0', 'translate-y-10'); }, 3000);
        }

        function renderAd(containerId, adCode) {
            if (!adCode) return;
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = adCode;
            Array.from(container.getElementsByTagName('script')).forEach(oldScript => {
                const newScript = document.createElement('script');
                Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                oldScript.parentNode.replaceChild(newScript, oldScript);
            });
        }

        async function loadUserPageData() {
            // Ads
            try {
                const docSnap = await getDoc(doc(db, "settings", "ads"));
                if (docSnap.exists()) {
                    const d = docSnap.data();
                    renderAd('ad-container-1', d.adSlot1);
                    renderAd('ad-container-2', d.adSlot2);
                    renderAd('ad-container-3', d.adSlot3);
                }
            } catch (e) { console.error(e); }

            // Settings
            try {
                const s = await getDoc(doc(db, "settings", "general"));
                if (s.exists()) timerDuration = s.data().timerDuration || 10;
            } catch (e) { console.error(e); }

            // Sliders
            try {
                const q = query(collection(db, "sliders"), orderBy("createdAt", "desc"));
                const s = await getDocs(q);
                sliderWrapper.innerHTML = ''; sliderDotsContainer.innerHTML = '';
                const slides = [];
                s.forEach(doc => slides.push(doc.data()));
                if (slides.length > 0) {
                    slides.forEach((slide, idx) => {
                        const div = document.createElement('div');
                        div.className = 'slider-item';
                        const img = `<img src="${slide.imageUrl}" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/1280x400?text=Error';">`;
                        div.innerHTML = slide.linkUrl ? `<a href="${slide.linkUrl}" target="_blank" class="block w-full h-full text-[0px]">${img}</a>` : img;
                        sliderWrapper.appendChild(div);
                        const dot = document.createElement('div');
                        dot.className = 'slider-dot'; dot.dataset.index = idx;
                        sliderDotsContainer.appendChild(dot);
                    });
                    setupSlider(slides.length);
                } else {
                    sliderWrapper.innerHTML = `<div class="slider-item flex items-center justify-center bg-gray-200 rounded-xl"><p class="text-gray-600">${getText('no_slides')}</p></div>`;
                }
            } catch (e) { console.error(e); }

            // Files
            try {
                const q = query(collection(db, "files"), orderBy("createdAt", "desc"));
                const snap = await getDocs(q);
                filesGrid.innerHTML = '';
                allFilesData = {};

                if (snap.empty) {
                    filesGrid.innerHTML = `<p class="col-span-full text-center text-gray-500">${getText('no_files_uploaded')}</p>`;
                    return;
                }
                
                snap.forEach(doc => {
                    const d = doc.data();
                    const obj = {
                        id: doc.id,
                        title: d.title,
                        description: d.description,
                        thumbnailUrl: d.thumbnailUrl,
                        requiredAds: d.requiredAds,
                        fileType: d.fileType || 'link',
                        contentValue: d.contentValue || d.downloadUrl || ""
                    };
                    allFilesData[doc.id] = obj;

                    const card = document.createElement('div');
                    card.className = 'file-card bg-white rounded-xl shadow-md overflow-hidden transform hover:-translate-y-2 transition-transform duration-300 hover:shadow-xl';
                    card.dataset.title = obj.title.toLowerCase();
                    card.dataset.description = obj.description.toLowerCase();
                    
                    let icon = 'fas fa-download';
                    if(obj.fileType === 'html') icon = 'fas fa-code';
                    if(obj.fileType === 'text') icon = 'fas fa-file-alt';

                    card.innerHTML = `
                        <img src="${obj.thumbnailUrl}" alt="${obj.title}" class="w-full aspect-video object-cover" onerror="this.src='https://placehold.co/400x225?text=Error';">
                        <div class="p-4">
                            <h3 class="text-lg font-bold text-gray-900 truncate" title="${obj.title}">${obj.title}</h3>
                            <p class="text-gray-600 text-sm mt-1 h-10 overflow-hidden">${obj.description}</p>
                            <button data-id="${obj.id}" data-required-ads="${obj.requiredAds||10}" class="download-btn w-full mt-4 py-2.5 px-4 rounded-lg text-white font-semibold shadow-md flex items-center justify-center gap-2 transition-all">
                                <i class="${icon}"></i> <span></span>
                            </button>
                        </div>
                    `;
                    filesGrid.appendChild(card);
                    updateButtonState(card.querySelector('.download-btn'));
                });
            } catch (e) {
                console.error(e);
                filesGrid.innerHTML = `<p class="col-span-full text-center text-red-500">${getText('files_error')}</p>`;
            }
        }

        function setupSlider(count) {
            if (count <= 1) { if(count===1) document.querySelector('.slider-dot').classList.add('active'); return; }
            const dots = document.querySelectorAll('.slider-dot');
            function go(idx) {
                currentSlide = (idx + count) % count;
                sliderWrapper.style.transform = `translateX(-${currentSlide * 100}%)`;
                dots.forEach(d => d.classList.remove('active'));
                if(dots[currentSlide]) dots[currentSlide].classList.add('active');
            }
            if(sliderInterval) clearInterval(sliderInterval);
            sliderInterval = setInterval(()=>go(currentSlide+1), 3000);
            dots.forEach(d => d.addEventListener('click', (e)=>go(parseInt(e.target.dataset.index))));
            go(0);
        }

        function updateButtonState(btn) {
            const id = btn.dataset.id;
            const data = allFilesData[id];
            if(!data) return;
            const req = parseInt(btn.dataset.requiredAds);
            const count = parseInt(localStorage.getItem(`adCount_${id}`)||0);
            const unlocked = count >= req;
            const span = btn.querySelector('span');
            const i = btn.querySelector('i');
            
            btn.disabled = false;
            btn.className = `download-btn w-full mt-4 py-2.5 px-4 rounded-lg text-white font-semibold shadow-md flex items-center justify-center gap-2 transition-all ${unlocked ? 'bg-gradient-to-r from-green-500 to-green-700 hover:from-green-600 hover:to-green-800' : 'bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700'}`;
            
            if (unlocked) {
                span.textContent = data.fileType === 'link' ? getText('download_now_button') : getText('view_now_button');
                i.className = data.fileType === 'link' ? 'fas fa-download' : 'fas fa-eye';
            } else {
                span.textContent = getText('unlock_button', { adCount: count, requiredCount: req });
                i.className = 'fas fa-lock';
            }
        }

        // --- BUTTON ACTION ---
        function handleAction(e) {
            const btn = e.target.closest('.download-btn');
            if(!btn || btn.disabled) return;
            e.preventDefault();

            const id = btn.dataset.id;
            const data = allFilesData[id];
            if(!data) return;

            const req = parseInt(btn.dataset.requiredAds);
            const count = parseInt(localStorage.getItem(`adCount_${id}`)||0);

            if(count >= req) {
                showToast('toast_download_starting');
                setTimeout(() => {
                    if(data.fileType === 'link') {
                        const w = window.open(data.contentValue, '_blank');
                        if(!w || w.closed || typeof w.closed=='undefined') window.location.href = data.contentValue;
                    } else {
                        openModal(data.title, data.contentValue, data.fileType);
                    }
                }, 1000);
            } else {
                processUnlock(btn);
            }
        }

        async function processUnlock(btn) {
            btn.disabled = true;
            const span = btn.querySelector('span');
            const id = btn.dataset.id;
            const req = parseInt(btn.dataset.requiredAds);
            let count = parseInt(localStorage.getItem(`adCount_${id}`)||0);

            try {
                span.textContent = getText('loading_ad');
                await show_9745051(); // Trigger Ad
                count++;
                localStorage.setItem(`adCount_${id}`, count);
                if(count >= req) {
                    showToast('toast_unlocked');
                    updateButtonState(btn);
                    return;
                }
                showToast('toast_progress', { adCount: count, requiredCount: req });
                let t = timerDuration;
                span.textContent = getText('verifying_button', { countdown: t });
                const iv = setInterval(() => {
                    t--;
                    if(t>0) span.textContent = getText('verifying_button', { countdown: t });
                    else { clearInterval(iv); updateButtonState(btn); }
                }, 1000);
            } catch (err) {
                console.error(err);
                showToast('toast_ad_error');
                updateButtonState(btn);
            }
        }

        // --- MODAL LOGIC (IFRAME) ---
        function openModal(title, content, type) {
            modalTitle.textContent = title;
            modalBody.innerHTML = '';
            modalFooter.classList.add('hidden');

            if(type === 'html') {
                // Create an isolated Iframe
                const iframe = document.createElement('iframe');
                iframe.className = "w-full h-full border-none";
                iframe.srcdoc = content; // Inject HTML code directly
                modalBody.appendChild(iframe);
            } else if (type === 'text') {
                modalBody.innerHTML = `<textarea readonly class="w-full h-full p-4 bg-gray-50 text-gray-800 font-mono text-sm resize-none focus:outline-none">${content}</textarea>`;
                modalFooter.classList.remove('hidden');
                copyBtn.onclick = () => {
                    navigator.clipboard.writeText(content).then(() => {
                        const original = copyBtn.innerHTML;
                        copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                        setTimeout(() => copyBtn.innerHTML = original, 2000);
                    });
                };
            }
            contentModal.classList.remove('hidden');
        }

        closeModalBtn.addEventListener('click', () => {
            contentModal.classList.add('hidden');
            modalBody.innerHTML = '';
        });

        // Search
        searchInput.addEventListener('input', () => {
            const val = searchInput.value.toLowerCase();
            let count = 0;
            document.querySelectorAll('.file-card').forEach(c => {
                if(c.dataset.title.includes(val) || c.dataset.description.includes(val)) {
                    c.style.display = 'block'; count++;
                } else c.style.display = 'none';
            });
            noResultsMessage.style.display = count===0 ? 'block' : 'none';
        });

        window.addEventListener('load', () => {
            const l = localStorage.getItem('userLanguage');
            if(l && translations[l]) applyLanguage(l);
            else languageModal.classList.remove('hidden');
        });
        filesGrid.addEventListener('click', handleAction);
        document.querySelectorAll('.lang-btn').forEach(b => b.addEventListener('click', () => applyLanguage(b.dataset.lang)));
    </script>
</body>
    </html>
